name: Build Skopeo

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Skopeo version to build (e.g., v1.14.0)'
        required: true
        type: string
      architecture:
        description: 'Target architecture'
        required: false
        type: choice
        options:
          - amd64
          - arm64
          - both
        default: both
      variant:
        description: 'Build variant (standalone/default/full or all)'
        required: false
        type: choice
        options:
          - standalone
          - default
          - full
          - all
        default: all

  # Called by check-releases workflow
  workflow_call:
    inputs:
      version:
        description: 'Skopeo version to build'
        required: true
        type: string

# Ensure only one build runs at a time per version
concurrency:
  group: build-skopeo-${{ inputs.version }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write  # Required for cosign OIDC

jobs:
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    steps:
      - name: Validate semver pattern
        env:
          VERSION: ${{ inputs.version }}
        run: |
          # Semver pattern: v1.2.3 or v1.2 or 1.2.3 or 1.2
          SEMVER_PATTERN='^v?[0-9]+\.[0-9]+(\.[0-9]+)?$'

          if [[ ! "$VERSION" =~ $SEMVER_PATTERN ]]; then
            echo "Error: Invalid version format '$VERSION'"
            echo "Expected format: v1.2.3 or v1.2 or 1.2.3 or 1.2"
            exit 1
          fi

          echo "âœ“ Version '$VERSION' is valid"

  build:
    name: Build skopeo-${{ matrix.variant }}-${{ matrix.arch }}
    needs: validate
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        arch: [amd64, arm64]
        variant: [standalone, default, full]
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Pull container image
        run: podman pull docker.io/ubuntu:rolling

      - name: Create build directory
        run: mkdir -p build

      - name: Run build and package in container
        env:
          VERSION: ${{ inputs.version }}
          TOOL: skopeo
          ARCH: ${{ matrix.arch }}
          VARIANT: ${{ matrix.variant }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          podman run --rm \
            -v ./scripts:/workspace/scripts:ro,z \
            -v ./build:/workspace/build:rw,z \
            -e VERSION=$VERSION \
            -e TOOL=$TOOL \
            -e ARCH=$ARCH \
            -e VARIANT=$VARIANT \
            -e GITHUB_TOKEN=$GITHUB_TOKEN \
            docker.io/ubuntu:rolling \
            bash -c "
              source /workspace/scripts/container/setup-build-env.sh && \
              /workspace/scripts/build-tool.sh $TOOL $ARCH $VARIANT && \
              /workspace/scripts/package.sh $TOOL $VERSION $ARCH $VARIANT
            "

      - name: Verify static linking
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          echo "Checking directory: build/skopeo-$ARCH/install/bin/"
          ls -la build/skopeo-$ARCH/install/bin/ || {
            echo "Error: Directory build/skopeo-$ARCH/install/bin/ not found"
            exit 1
          }

          found_binary=false
          for binary in build/skopeo-$ARCH/install/bin/*; do
            # Skip if glob didn't match any files (bash returns the pattern itself)
            if [[ ! -f "$binary" ]]; then
              echo "Skipping non-file: $binary"
              continue
            fi

            found_binary=true
            echo "Checking: $binary"
            output=$(ldd "$binary" 2>&1 || true)
            if echo "$output" | grep -q "not a dynamic executable\|statically linked"; then
              echo "âœ“ $binary is statically linked"
            else
              echo "âœ— $binary is NOT statically linked:"
              echo "$output"
              exit 1
            fi
          done

          if [[ "$found_binary" == "false" ]]; then
            echo "Error: No binaries found in build/skopeo-$ARCH/install/bin/"
            exit 1
          fi

      - name: Test skopeo binary
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          echo "Testing skopeo binary on native ${{ matrix.arch }} runner..."
          ./build/skopeo-$ARCH/install/bin/skopeo --version
          echo "âœ“ skopeo binary works correctly"

      - name: Set tarball name
        id: tarball
        env:
          VARIANT: ${{ matrix.variant }}
          ARCH: ${{ matrix.arch }}
        run: |
          # default variant uses simple name, others include variant
          if [[ "$VARIANT" == "default" ]]; then
            TARBALL_NAME="skopeo-linux-${ARCH}.tar.zst"
          else
            TARBALL_NAME="skopeo-${VARIANT}-linux-${ARCH}.tar.zst"
          fi
          echo "name=$TARBALL_NAME" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: skopeo-${{ matrix.variant }}-${{ matrix.arch }}
          path: |
            build/${{ steps.tarball.outputs.name }}
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    if: success()  # Only create release if all matrix builds succeeded
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/

      - name: Consolidate artifacts
        run: |
          mkdir -p release/
          find artifacts/ -type f -name "*.tar.zst" -exec cp {} release/ \;
          ls -lh release/

      - name: Setup cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Generate checksums and sign artifacts
        run: |
          chmod +x scripts/sign-release.sh
          scripts/sign-release.sh release/

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ inputs.version }}
        run: |
          TAG="skopeo-${VERSION}"

          # Create release notes
          cat > /tmp/release-notes.md <<'NOTES'
          Static binaries for skopeo built with Clang + musl + mimalloc (containerized build)

          **ARCHITECTURES**
            - linux/amd64
            - linux/arm64

          **VARIANTS**
            - `skopeo-linux-{arch}.tar.zst`: Default variant with registry configs (â­ RECOMMENDED)
            - `skopeo-standalone-linux-{arch}.tar.zst`: Binary only
            - `skopeo-full-linux-{arch}.tar.zst`: Alias for default (skopeo needs no runtime components)

          **NOTE**: All skopeo variants are essentially the same (~30MB) since skopeo is a registry client tool that doesn't run containers. The default variant includes registry configuration files.

          **INSTALLATION**
          ```bash
          # Download tarball for your architecture (default variant recommended)
          curl -fsSL -O https://github.com/${{ github.repository }}/releases/download/skopeo-${{ inputs.version }}/skopeo-linux-amd64.tar.zst

          # Extract
          tar -xf skopeo-linux-amd64.tar.zst
          cd skopeo-${{ inputs.version }}

          # Install system-wide
          sudo cp -r usr/* /usr/
          sudo cp -r etc/* /etc/

          # Or use from current directory
          export PATH=$PWD/usr/local/bin:$PATH
          skopeo --version
          ```

          **VERIFICATION**

          All tarballs include SHA256 checksums and cosign signatures (keyless OIDC).

          Verify checksum:
          ```bash
          sha256sum -c checksums.txt --ignore-missing
          ```

          Verify cosign signature (example):
          ```bash
          cosign verify-blob \
            --bundle=skopeo-linux-amd64.tar.zst.bundle \
            --certificate-identity-regexp='https://github.com/.*' \
            --certificate-oidc-issuer='https://token.actions.githubusercontent.com' \
            skopeo-linux-amd64.tar.zst
          ```

          **BUILD DETAILS**
            - Built inside docker.io/ubuntu:rolling container using podman
            - Compiler: Clang with musl target + mimalloc allocator
            - Workflow ${{ github.workflow }}
            - Run ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          NOTES

          # Create or update release
          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG already exists, uploading additional assets..."
            gh release upload "$TAG" release/* --clobber
          else
            echo "Creating new release $TAG..."
            gh release create "$TAG" \
              --title "Skopeo ${VERSION}" \
              --notes-file /tmp/release-notes.md \
              release/*
          fi

      - name: Release Summary
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "### ðŸš€ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: skopeo-${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download**: https://github.com/${{ github.repository }}/releases/tag/skopeo-${VERSION}" >> $GITHUB_STEP_SUMMARY
